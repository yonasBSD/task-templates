---
# https://taskfile.dev

version: '3'

vars:
  IMAGE_NODE: node:lts-bullseye
  SRC_MOUNT_POINT: /data

tasks:

  install:
    desc: "[YARN] Install nodejs modules with yarn. Arguments: [PULL|P=n|N] (*)"
    summary: |
      [YARN] Install nodejs modules with yarn.
      Usage: task yarn:install [PULL|P=<n|N>]

      Arguments:
       PULL | P  Pull docker image (optional, by default yes)
    vars:
      PULL: '{{default .P .PULL}}'
    cmds:
      - if [ "{{.PULL}}" != "n" ] && [ "{{.PULL}}" != "N" ]; then docker pull "{{.IMAGE_NODE}}"; fi
      - docker run --rm -t -v $(pwd):"{{.SRC_MOUNT_POINT}}" -w "{{.SRC_MOUNT_POINT}}" node:lts-bullseye yarn --cache-folder "{{.SRC_MOUNT_POINT}}/.node_cache" install
    preconditions:
      - sh: command -v docker
        msg: "docker is not installed"
    silent: true

  outdated:
    desc: "[YARN] Check outdated npm packages. Arguments: [PULL|P=n|N] (*)"
    summary: |
      [YARN] Check outdated npm packages.
      Usage: task yarn:outdated [PULL|P=<n|N>]

      Arguments:
       PULL | P  Pull docker image (optional, by default yes)
    vars:
      PULL: '{{default .P .PULL}}'
    cmds:
      - if [ "{{.PULL}}" != "n" ] && [ "{{.PULL}}" != "N" ]; then docker pull "{{.IMAGE_NODE}}"; fi
      - docker run --rm -t -v $(pwd):"{{.SRC_MOUNT_POINT}}" -w "{{.SRC_MOUNT_POINT}}" node:lts-bullseye yarn --cache-folder "{{.SRC_MOUNT_POINT}}/.node_cache" outdated || true
    preconditions:
      - sh: command -v docker
        msg: "docker is not installed"
    silent: true

  upgrade:
    desc: "[YARN] Upgrade npm packages. Arguments: [PULL|P=n|N] (*)"
    summary: |
      [YARN] Upgrade npm packages.
      Usage: task yarn:upgrade [PULL|P=<n|N>]

      Arguments:
       PULL | P  Pull docker image (optional, by default yes)
    vars:
      PULL: '{{default .P .PULL}}'
    cmds:
      - if [ "{{.PULL}}" != "n" ] && [ "{{.PULL}}" != "N" ]; then docker pull "{{.IMAGE_NODE}}"; fi
      - docker run --rm -t -v $(pwd):"{{.SRC_MOUNT_POINT}}" -w "{{.SRC_MOUNT_POINT}}" node:lts-bullseye yarn --cache-folder "{{.SRC_MOUNT_POINT}}/.node_cache" upgrade
    preconditions:
      - sh: command -v docker
        msg: "docker is not installed"
    silent: true

  clean:
    desc: "[YARN] Remove node_modules and .node_cache directories"
    cmds:
      - rm -rf .node_cache
      - rm -rf node_modules
    silent: true
