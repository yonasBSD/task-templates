---
# https://taskfile.dev

version: '3'

vars:
  DIR_TASKFILES: "Taskfile.d"
  FILE_TASK_START: "task-start-{{.TASK}}.txt"
  TT_GIT_REPO: "https://gitlab.com/op_so/task/task-templates/-/raw/main"

includes:
# git:
#   taskfile: "./Taskfile.d/git.yml"
#   optional: true
# lint:
#   taskfile: "./Taskfile.d/lint.yml"
#   vars:
#     FILELINT_IGNORE: .git/,.ssh/
#   optional: true
# mp:
#   taskfile: "./Taskfile.d/multipass.yml"
#   optional: true
# sys:
#   taskfile: "./Taskfile.d/system.yml"
#   optional: true
# yarn:
#   taskfile: "./Taskfile.d/yarn.yml"
#   optional: true

tasks:

  01-download:
    desc: "[CORE] Download necessary resources."
    cmds:
      - date > {{.FILE_TASK_START}}
      - defer: rm -f {{.FILE_TASK_START}}
      - mkdir -p "{{.DIR_TASKFILES}}"
      # - curl --progress-bar -o "{{.DIR_TASKFILES}}/git.yml" "{{.TT_GIT_REPO}}/{{.DIR_TASKFILES}}/git.yml"
      # - curl --progress-bar -o "{{.DIR_TASKFILES}}/lint.yml" "{{.TT_GIT_REPO}}/{{.DIR_TASKFILES}}/lint.yml"
      # - curl --progress-bar -o "{{.DIR_TASKFILES}}/multipass.yml" "{{.TT_GIT_REPO}}/{{.DIR_TASKFILES}}/multipass.yml"
      # - curl --progress-bar -o "{{.DIR_TASKFILES}}/system.yml" "{{.TT_GIT_REPO}}/{{.DIR_TASKFILES}}/system.yml"
      # - curl --progress-bar -o "{{.DIR_TASKFILES}}/yarn.yml" "{{.TT_GIT_REPO}}/{{.DIR_TASKFILES}}/yarn.yml"
      - echo "Download Start $(cat {{.FILE_TASK_START}}) - End $(date)"
    preconditions:
      - sh: command -v curl
        msg: "curl is not installed"
    silent: true

  usage:
    desc: "[CORE] Show the usage of a task. Arguments: TSK|T=task-name (*)"
    summary: |
      [CORE] Show the usage of a task.
      Usage: task usage TSK|T=<task-name>

      Arguments:
       TSK | T Name of the task (required)
    vars:
      TSK: '{{default .T .TSK}}'
    cmds:
      - task --summary "{{.TSK}}" | sed '/^dependencies:$/,$d' | sed '/^commands:$/,$d'
    preconditions:
      - sh: test -n "{{.TSK}}" || test -n "{{.T}}"
        msg: "TSK|T argument is required"
    silent: true

  default:
    desc: "[CORE] List of available tasks."
    vars:
      TASKS_LIST:
        sh: task --list
    cmds:
      - |
        {{ range $i, $line := .TASKS_LIST | splitLines -}}
          first_char="$(printf '%s' "{{ $line }}" | cut -c1)"
          if [ "$first_char" = "*" ]; then
             task=$(echo "{{ $line }}" | cut -d ' ' -f2)
             desc=$(echo "{{ $line }}" | sed -e "s/^\* $task//" | sed 's/^[[:space:]]*//g')
             printf "\e[32m%-25s \033[0m %s\n" "* $task" "$desc"
          else
            echo "{{ $line }}"
          fi
        {{ end -}}
      - echo ""
      - echo " (*) <task usage TSK=task-name> will show the usage of the task."
      - echo ""
    silent: true
